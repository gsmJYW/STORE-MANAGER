<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        @import url(//fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700&display=swap);
        @import url(//cdn.jsdelivr.net/gh/wan2land/d2coding/d2coding-full.css);

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        table {
            border-spacing: 0;
            width: 100%;
            border: 1px solid #ddd;
        }

        th,
        td {
            text-align: left;
            padding: 16px;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2
        }

        .swal-option {
            display: grid !important;
        }

        .container {
            height: 100%;
        }

        body {
            background-color: white;
            color: black;
            font-size: 25px;
            height: 100vh;
        }
    </style>

    <title>STORE MANAGER - CJ 배송 조회</title>
    <link rel="icon" type="image/x-icon" href="https://imgur.com/YPhrrAJ.png">

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.0-beta1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" />

    <meta name="google-signin-client_id"
        content="36522862962-n5ba78aee74h5jggnppe3udfoupipu35.apps.googleusercontent.com">
    <meta name="google-signin-cookiepolicy" content="single_host_origin">
    <meta name="google-signin-scope" content="profile email">
</head>

<body>
    <div class="container align-items-center justify-content-center">
        <p></p>
        <div class="d-flex" style="width: 680px; margin: auto">
            <form action="/">
                <button type="submit" style="background: none; border: none; outline: none">
                    <i id="home-icon" class="fa fa-home" style="font-size: 32px; margin: 1px 8px 18px 0px"></i>
                </button>
            </form>
            <h2 style="font-size: 30px; font-weight: 600; margin-bottom: auto">CJ 배송 조회</h2>
        </div>
        <div class="d-flex p-2 border" style="width: 680px; margin: auto">
            <span style="margin: auto">CJ 송장 번호 12자리가 열거된 텍스트를 입력해주세요</span>
            <button id="example-button" type="button" class="btn btn-primary" style="margin: auto; font-size: 14px">
                예시&nbsp;
                <i class="fa fa-question"></i>
            </button>
            <button id="paste-button" type="button" class="btn btn-primary" style="margin: auto; font-size: 14px">
                붙여넣기&nbsp;
                <i class="fa fa-paste"></i>
            </button>
            <button id="upload-button" type="button" class="btn btn-primary" style="margin: auto; font-size: 14px">
                업로드&nbsp;
                <i class="fa fa-upload"></i>
            </button>
        </div>
        <div class="container" id="result" style="width: 1120px" hidden>
            <p>&nbsp;</p>
            <div id="sort-form">
                <!-- <div class="form-check form-check-inline" style="padding: 0px 2px 0px 14px; margin: 0px 8px 0px 0px">
                    <input class="form-check-input" type="checkbox" id="load-all" value="load-all">
                    <label class="form-check-label">전부 로딩하기</label>
                </div>
                <div class="form-check form-check-inline" style="padding: 0px 2px 0px 20px; margin: 0px 8px 0px 0px">
                    <input class="form-check-input" type="checkbox" id="highlight-changes" value="highlight-changes"
                        checked>
                    <label class="form-check-label">바뀐 제품을 위로</label>
                </div>
                <div class="form-check form-check-inline" style="padding: 0px 2px 0px 20px; margin: 0px 8px 0px 0px">
                    <input class="form-check-input" type="radio" name="sort-radio" id="by-recent" value="by-recent"
                        checked>
                    <label class="form-check-label">최신 순으로</label>
                </div>
                <div class="form-check form-check-inline" style="padding: 0px 2px 0px 20px; margin: 0px 8px 0px 0px">
                    <input class="form-check-input" type="radio" name="sort-radio" id="by-popularity"
                        value="by-popularity">
                    <label class="form-check-label">인기 순으로</label>
                </div> -->
                <div class="d-flex" style="float: right; margin: auto">
                    <span id="tracking-amount" style="margin: 10px 8px 0px 0px"></span>
                    <button id="excel-export-button" type="button" class="btn btn-primary"
                        style="margin: 6px 0px; padding: 4px 10px; font-size: 14px">
                        엑셀 파일 (.xlsx)&nbsp;
                        <i class="fa fa-download"></i>
                    </button>
                </div>
            </div>
            <table id="result-table"></table>
            <span>&nbsp;<br>&nbsp;<br></span>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.0-beta1/js/bootstrap.bundle.min.js"></script>
        <script type="module">
            let trackingList = []

            document.getElementById('example-button').addEventListener('click', async () => {
                let exampleIndex = 0

                swal.fire({
                    title: '예시',
                    html: `
                        <div style="line-height: 130%;">
                            숫자 이외의 다른 텍스트는 자동으로 제거됩니다.<br>
                            어떤 방식으로든 숫자 사이를 구분해놓으면 됩니다.<br><br>
                        </div>
                        <div id="example-swal" style="font-weight: 500">
                            
                        </div>
                    `,
                    confirmButtonText: '알겠어요',
                }).then(() => {
                    document.getElementById('example-swal').remove()
                })

                while (document.getElementById('example-swal')) {
                    let example

                    switch (exampleIndex) {
                        case 0:
                            example = '517290228869 638444429500 576955233060'
                            break

                        case 1:
                            example = '623054983674, 509717267240, 474057435170'
                            break

                        case 2:
                            example = '517570774347/550191048862/645552411926'
                            break

                        case 3:
                            example = '563997156284-610459116654-508392644830'
                            break
                    }

                    document.getElementById('example-swal').innerText = example

                    exampleIndex++
                    if (exampleIndex >= 4) {
                        exampleIndex = 0
                    }

                    await new Promise(resolve => setTimeout(resolve, 1000))
                }
            })

            document.getElementById('paste-button').addEventListener('click', async () => {
                showLoading('배송 조회를 하는 중이에요.')

                let clipboard = await navigator.clipboard.readText();
                let numericSplit = clipboard.replace(/\D/g, ' ');

                let invcNoList = []

                for (let numeric of numericSplit.split(' ')) {
                    let num = Number(numeric)

                    if (numeric.length == 12) {
                        if (invcNoList.filter((invcNo) => invcNo == num).length <= 0) {
                            invcNoList.push(num)
                        }
                    }
                }

                if (invcNoList.length <= 0) {
                    showWarning('송장번호를 찾지 못했어요.')
                    return
                }

                try {
                    let json = await postAsync('/cjTracking', { invcNo: invcNoList })

                    if (json.result == 'error') {
                        throw new Error(json.error)
                    }

                    trackingList = json.cjTracking.filter((tracking) => tracking.available == true)
                    updateTable()
                    swal.close()
                }
                catch (error) {
                    showError('배송 조회를 하는 도중 오류가 발생했어요.')
                }
            })



            // 테이블

            const result = document.getElementById('result')
            const resultTable = document.getElementById('result-table')
            const trackingAmount = document.getElementById('tracking-amount')

            let table = []

            document.getElementById('sort-form').addEventListener('input', () => {
                updateTable()
            })

            function updateTable() {
                resultTable.innerHTML = ''
                table = []

                for (let tracking of trackingList) {
                    let row = {
                        id: tracking.id,
                        receiver: tracking.receiver,
                        product: tracking.product,
                        progress: '',
                        lastUpdate: '',
                    }

                    if (tracking.progress.length > 0) {
                        let lastTracking = tracking.progress.pop()
                        row.progress = lastTracking.step
                        row.lastUpdate = new Date(lastTracking.time).toLocaleString('ko-KR')
                    }
                    else {
                        row.progress = '정보없음'
                        row.lastUpdate = ''
                    }

                    table.push(row)
                }

                table.sort((a, b) => a.id - b.id)

                let tr = document.createElement('tr')
                resultTable.appendChild(tr)

                let th1 = document.createElement('th')
                th1.innerHTML = '송장 번호'

                let th2 = document.createElement('th')
                th2.innerHTML = '수령인'

                let th3 = document.createElement('th')
                th3.innerHTML = '제품'

                let th4 = document.createElement('th')
                th4.innerHTML = '상태'

                let th5 = document.createElement('th')
                th5.innerHTML = '최근 업데이트'

                for (let th of [th1, th2, th3, th4, th5]) {
                    th.setAttribute('style', 'font-weight: 600')
                    tr.appendChild(th)
                }

                for (let row of table) {
                    let tr = document.createElement('tr')
                    resultTable.appendChild(tr)

                    let a = document.createElement('a')

                    a.setAttribute('href', `https://www.doortodoor.co.kr/parcel/doortodoor.do?fsp_action=PARC_ACT_002&fsp_cmd=retrieveInvNoACT&invc_no=${row.id}`)
                    a.setAttribute('target', '_blank')
                    a.innerHTML = row.id
                    // a.innerHTML = row.title.match(/.{1,40}/g).join('<br>')

                    let th1 = document.createElement('th')
                    th1.appendChild(a)

                    let th2 = document.createElement('th')
                    th2.innerHTML = row.receiver

                    let th3 = document.createElement('th')

                    if (row.product.length > 24) {
                        th3.innerHTML = `${row.product.slice(0, 32)} ...`
                    }
                    else {
                        th3.innerHTML = row.product
                    }

                    let th4 = document.createElement('th')
                    th4.innerHTML = row.progress

                    let th5 = document.createElement('th')
                    th5.innerHTML = row.lastUpdate.toLocaleString('ko-KR')

                    for (let th of [th1, th2, th3, th4, th5]) {
                        th.setAttribute('style', 'font-weight: 400')
                        tr.appendChild(th)
                    }
                }

                trackingAmount.innerText = `${table.length.toLocaleString('ko-KR')}건`
                result.hidden = false
            }



            // 엑셀

            document.getElementById('excel-export-button').addEventListener('click', async () => {
                let ws = XLSX.utils.json_to_sheet(table)

                ws.A1.v = '송장번호'
                ws.B1.v = '수령인'
                ws.C1.v = '제품'
                ws.D1.v = '상태'
                ws.E1.v = '최근 업데이트'

                for (let index = 1; index <= table.length; index++) {
                    let idCell = ws[`A${index}`]

                    idCell.f = `=HYPERLINK("https://www.doortodoor.co.kr/parcel/doortodoor.do?fsp_action=PARC_ACT_002&fsp_cmd=retrieveInvNoACT&invc_no=${idCell.v}", "${idCell.v}")`
                }

                let wb = XLSX.utils.book_new()
                XLSX.utils.book_append_sheet(wb, ws, 'CJ 배송 조회')
                XLSX.writeFile(wb, `CJ 배송 조회.xlsx`)
            })



            // 자주 사용하는 함수

            function showError(html, errorMessage) {
                swal.fire({
                    title: '이런!',
                    html: html,
                    icon: 'error',
                    confirmButtonText: '어떻게 된거죠?',
                    cancelButtonText: '알겠어요',
                    showCancelButton: true,
                    heightAuto: false,
                }).then((res) => {
                    if (res.isConfirmed) {
                        swal.fire({
                            title: '원인',
                            html: errorMessage,
                            confirmButtonText: '알겠어요',
                            showCancelButton: false,
                            heightAuto: false,
                        })
                    }
                })
            }

            function showWarning(html) {
                swal.fire({
                    title: '잠시만요!',
                    html: html,
                    confirmButtonText: '알겠어요',
                    heightAuto: false,
                })
            }

            function showLoading(html) {
                swal.fire({
                    title: '잠시만요!',
                    html: html,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    heightAuto: false,
                })
                swal.showLoading()
            }

            function postAsync(url, params = {}) {
                return new Promise((resolve, reject) => {
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(params),
                    }).then(async (res) => {
                        resolve(await res.json())
                    }).catch((error) => reject(error))
                })
            }
        </script>
</body>

</html>